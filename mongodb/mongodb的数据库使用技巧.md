# mongodb的数据库使用技巧



1. ## 关于连接到mongodb

   1. 关于驱动程序：总是选择与所用之的Mongodb相兼容的驱动程序，可以从驱动兼容列表中查到

   2. 关于廉洁对象 Mongoclient ： 使用mongoClient对象链接到MongoDB实例时总是应该保证他是单例模式，并且在整个生命周期中都是从它获取其他操作对象。

   3. 关于链接字符串：连接字符串中可以配置大部分链接选项，建议总是在链接字符串中配置这些选项；

      

      |   参数名称    | 含义       | 推荐设置                             |
      | :-----------: | ---------- | ------------------------------------ |
      |  maxPoolSize  | 连接池大小 |                                      |
      | Max Wait Time | 访问超时   | 建议设置，自动杀掉过慢查询           |
      | Write Concern | 写成功设置 | 建议设置 majority 保证数据安全       |
      | Read Concern  | 读成功     | 对于数据一致性比较高的场景适当使用4. |

2. ##  不要在Mongos前面使用负载均衡

   因为驱动已经在知晓在不同的mongos之间实现负载均衡，而复制集则需要根据节点的角色来选在发送请求的目标。如果在mongos或者复制集上层部署负载均衡：

   1. 驱动会无法探测到具体的那个节点存活，从而无法完成自动故障恢复；
   2. 驱动会午饭判断游标是在那个基点创建的，从而便利游标时出错
   3. 结论：不要在mongos或者复制集上层放置负载均衡，让驱动处理负载均衡和自动故障恢复

3. ## 游标的使用：

   如果数据集比较大，一个游标已经遍历完了，则会自动关闭；如果没有遍历完即要手动关闭

4. ## 关于查询及索引

   1. 每一个查询都必须有对应的索引
   2. 尽量使用覆盖索引（convered Indexes）可以避免读数据文件
   3. 使用projection来减少返回到客户端的额文档内容

5. ## 关于写入

   1. 在update语句中只包含需要更新的字段
   2. 尽可能使用批量插入来提升写入性能
   3. 使用ttl自动过期日志类型的数据

6. ## 关于文档结构

   1. 放置使用太长的字段名（浪费空间）
   2. 放置使用太深的数组嵌套（超过两层就比较复杂）
   3. 不用使用中文，标点符号等非拉丁文字母作为字段名

7. ## 关于事务

   1. 无论何时，事务的使用总是能避免则避免；
   2. 模型设计先于事务，尽可能使用模型设计规避事务
   3. 不用使用过大的事务（尽量控制在1000个文档以内）；
   4. 当必须使用事务的时候，尽可能让涉及事务文档分布在同一个分片上，这样可以有效的提高效率

   

   

   

   





